<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sui.haedal.mapper.EarnMapper">

    <select id="vaultMinOrMaxTimeYield" resultType="com.sui.haedal.model.vo.VaultYieldVo">
        SELECT * FROM vault_yield_earned_record where transaction_time_unix=#{minTime} or transaction_time_unix=#{maxTime} ORDER BY transaction_time_unix desc
    </select>
    <select id="vaultYield24HourTimeRangeMixAndMaxTime" resultType="com.sui.haedal.model.vo.VaultYieldVo" >
        SELECT min(transaction_time_unix) min_time,max(transaction_time_unix) max_time FROM vault_yield_earned_record where transaction_time&gt;=DATE_SUB(NOW(), INTERVAL 24 HOUR)  and transaction_time&lt;=NOW()
    </select>
    <select id="allVaultYield" resultType="com.sui.haedal.model.vo.VaultYieldVo">
        SELECT v.vault_id,v.asset_type,cc.feed_id asset_type_feed_id,cc.coin_decimals asset_decimals,y.earned_asset,y.transaction_time from vault v
        inner join
        (SELECT vault_id,earned_asset,transaction_time from vault_yield_earned_record where  earned_asset>0 and transaction_time&gt;=DATE_SUB(NOW(), INTERVAL 1 MINUTE) and transaction_time&lt;=NOW()) y on y.vault_id=v.vault_id
        left join coin_config cc on cc.coin_type=v.asset_type
    </select>
    <select id="vaultApy" resultType="com.sui.haedal.model.vo.VaultVo">
        SELECT vault_id,MAX(transaction_time) transaction_time,ANY_VALUE(apy) apy from vault_apy
         <if test="vaultId!=null and vaultId!=''">
             where vault_id=#{vaultId}
         </if>
         GROUP BY vault_id
    </select>
    <select id="vaultStrategy" resultType="com.sui.haedal.model.vo.StrategyVo">
       SELECT vbc.vault_id,v.total_asset vault_tvl,b.market_title,b.total_supply_amount,b.collateral_token_type,b.loan_token_type,
        cc.feed_id loan_feed_id,cc.feed_object_id loan_feed_object_id,cc.coin_decimals loan_coin_decimals,
        vbc.cap,vbc.weight_bps,rd.borrow_rate apy from vault_set_allocation_cap vbc
        INNER JOIN (select vault_id,market_id,MAX(transaction_time) transaction_time from vault_set_allocation_cap where vault_id=#{vaultId} GROUP BY vault_id,market_id) lastvbc
        on lastvbc.vault_id=vbc.vault_id and lastvbc.market_id=vbc.market_id and lastvbc.transaction_time=vbc.transaction_time
        LEFT JOIN vault v ON v.vault_id = vbc.vault_id
        left join borrow b on b.market_id=vbc.market_id
        left join coin_config cc on b.loan_token_type=cc.coin_type
        left join (SELECT market_id,max(transaction_time) transaction_time,ANY_VALUE(borrow_rate) borrow_rate from rate_detail GROUP BY market_id) rd on rd.market_id=vbc.market_id
    </select>

    <select id="allVaultStrategy" resultType="com.sui.haedal.model.vo.StrategyVo">
        SELECT b.market_id,vbc.vault_id,b.collateral_token_type,b.loan_token_type,vbc.cap,vbc.weight_bps,b.lltv from vault_set_allocation_cap vbc
        INNER JOIN (select vault_id,market_id,MAX(transaction_time) transaction_time from vault_set_allocation_cap  GROUP BY vault_id,market_id) lastvbc
        on lastvbc.vault_id=vbc.vault_id and lastvbc.market_id=vbc.market_id and lastvbc.transaction_time=vbc.transaction_time
        left join borrow b on b.market_id=vbc.market_id
    </select>

    <select id="allVaultNewCurator" resultType="com.sui.haedal.model.vo.VaultVo">
        SELECT vsc.vault_id,vsc.new_curator as curator from vault_set_curator_record vsc
        INNER JOIN (select vault_id,max(transaction_time_unix) transaction_time_unix from vault_set_curator_record GROUP BY vault_id) rs
        on vsc.transaction_time_unix=rs.transaction_time_unix and vsc.vault_id=rs.vault_id;
    </select>

    <select id="allVaultNewAllocator" resultType="com.sui.haedal.model.vo.VaultVo">
        SELECT vsc.vault_id,vsc.new_allocator as allocator from vault_set_allocator_record vsc
        INNER JOIN (select vault_id,max(transaction_time_unix) transaction_time_unix from vault_set_allocator_record GROUP BY vault_id) rs
        on vsc.transaction_time_unix=rs.transaction_time_unix and vsc.vault_id=rs.vault_id;
    </select>

    <select id="vaultDetail" resultType="com.sui.haedal.model.vo.VaultVo">
        SELECT v.*,b.collateral_token_type,b.lltv from vault v
        left join vault_set_allocation_cap vbc on vbc.vault_id=v.vault_id
        left join borrow b on b.market_id=vbc.market_id
        where v.vault_id=#{vaultId}
    </select>

    <select id="depositMinTimeVaultCreateTime" resultType="long">
        SELECT transaction_time_unix from vault where vault_id=
        (SELECT vault_id from vault_deposit where transaction_time_unix=
        (SELECT min(transaction_time_unix) minTime from vault_deposit
        where 1=1
        <choose>
            <when test="statisticalRole==true">
                AND user = #{userAddress}
            </when>
            <otherwise>
                AND vault_id =#{businessPoolId}
            </otherwise>
        </choose>
        ));

    </select>

    <select id="vaultDepositMinTime" resultType="date">
        SELECT min(transaction_time) minTime from vault_deposit WHERE  transaction_time &gt;= #{start} AND transaction_time &lt;= #{end}
        <choose>
            <when test="statisticalRole==true">
                AND user = #{userAddress}
            </when>
            <otherwise>
                AND vault_id =#{businessPoolId}
            </otherwise>
        </choose>
    </select>

    <select id="vaultTvlMinTime" resultType="date">
        SELECT min(transaction_time) minTime from vault_tvl_record WHERE vault_id =#{businessPoolId} and transaction_time &gt;= #{start} AND transaction_time &lt;= #{end}
    </select>

    <select id="vaultTvlTimePeriodStatistics" resultType="com.sui.haedal.model.vo.TimePeriodStatisticsVo">
        SELECT vtc.total_asset as val,groupLastTime.*,cc.coin_type,cc.feed_id FROM  (
        SELECT DATE_FORMAT(transaction_time,#{mysqlDateFormat}) AS dateUnit,max(transaction_time) transaction_time,vault_id
        from vault_tvl_record  where vault_id=#{businessPoolId} and transaction_time &gt;= #{start} AND transaction_time &lt;= #{end}
        GROUP BY dateUnit) groupLastTime
        inner join vault_tvl_record vtc on vtc.vault_id=groupLastTime.vault_id and vtc.transaction_time=groupLastTime.transaction_time
        LEFT JOIN coin_config cc ON cc.coin_type = vtc.asset_type
    </select>

    <select id="vaultDeposit" resultType="com.sui.haedal.model.vo.TimePeriodStatisticsVo">
        SELECT
        vaultDepositTotal.*,
        cc.feed_id
        FROM
        (
        SELECT
        DATE_FORMAT( max( transaction_time ), '%Y-%m-%d %H:%i' ) AS transaction_time,
        DATE_FORMAT( transaction_time, #{mysqlDateFormat}) AS dateUnit,
        sum(asset_amount) AS val,
        vault_id,
        max(asset_type) coin_type
        FROM
        vault_deposit
        WHERE  transaction_time &gt;= #{start} AND transaction_time &lt;= #{end}
        <choose>
            <when test="statisticalRole==true">
                AND user = #{userAddress}
            </when>
            <otherwise>
                AND vault_id =#{businessPoolId}
            </otherwise>
        </choose>
        GROUP BY
        dateUnit,
        vault_id
        ) vaultDepositTotal
        LEFT JOIN coin_config cc ON cc.coin_type = vaultDepositTotal.coin_type
        ORDER BY
        vaultDepositTotal.dateUnit
    </select>

    <select id="vaultDepositLTTransactionTime" resultType="com.sui.haedal.model.vo.TimePeriodStatisticsVo">
        SELECT
        vaultDepositTotal.*,
        cc.feed_id
        FROM
        (
        SELECT
        vault_id,sum(asset_amount) AS val,max(asset_type) coin_type
        FROM vault_deposit
        WHERE  transaction_time &lt;= #{start}
        <choose>
            <when test="statisticalRole==true">
                AND user = #{userAddress}
            </when>
            <otherwise>
                AND vault_id =#{businessPoolId}
            </otherwise>
        </choose>
        GROUP BY vault_id
        ) vaultDepositTotal
        LEFT JOIN coin_config cc ON cc.coin_type = vaultDepositTotal.coin_type
    </select>

    <select id="vaultWithdraw" resultType="com.sui.haedal.model.vo.TimePeriodStatisticsVo">
        SELECT
        vaultWithdrawTotal.*,
        cc.feed_id
        FROM
        (
        SELECT
        DATE_FORMAT( max( transaction_time ), '%Y-%m-%d %H:%i' ) AS transaction_time,
        DATE_FORMAT(transaction_time, #{mysqlDateFormat}) AS dateUnit,
        sum(asset_amount) AS val,
        vault_id,
        max( asset_type) AS coin_type
        FROM
        vault_withdraw
        WHERE   transaction_time &gt;= #{start} AND transaction_time &lt;= #{end}
        <choose>
            <when test="statisticalRole==true">
                AND user = #{userAddress}
            </when>
            <otherwise>
                AND vault_id =#{businessPoolId}
            </otherwise>
        </choose>
        GROUP BY dateUnit,vault_id
        ) vaultWithdrawTotal
        LEFT JOIN coin_config cc ON cc.coin_type = vaultWithdrawTotal.coin_type
        ORDER BY
        vaultWithdrawTotal.dateUnit
    </select>

    <select id="vaultWithdrawLTTransactionTime" resultType="com.sui.haedal.model.vo.TimePeriodStatisticsVo">
        SELECT
        vaultWithdrawTotal.*,
        cc.feed_id
        FROM
        (
        SELECT
        vault_id,sum(asset_amount) AS val,max(asset_type) AS coin_type
        FROM vault_withdraw
        WHERE  transaction_time &lt;= #{start}
        <choose>
            <when test="statisticalRole==true">
                AND user = #{userAddress}
            </when>
            <otherwise>
                AND vault_id =#{businessPoolId}
            </otherwise>
        </choose>
        GROUP BY vault_id
        ) vaultWithdrawTotal
        LEFT JOIN coin_config cc ON cc.coin_type = vaultWithdrawTotal.coin_type
    </select>

    <select id="vaultAPYStatistics" resultType="com.sui.haedal.model.vo.TimePeriodStatisticsVo">
        <!-- SELECT
        DATE_FORMAT(max(transaction_time), '%Y-%m-%d %H:%i' ) AS transaction_time,
        DATE_FORMAT(transaction_time, #{mysqlDateFormat}) AS dateUnit,
        max(apy) AS val
        FROM vault_apy
        WHERE  transaction_time &gt;= #{start} AND transaction_time &lt;= #{end}  and vault_id =#{businessPoolId}
        GROUP BY dateUnit -->
        SELECT groupLastTime.*,va.apy as val from (
        SELECT max(transaction_time) AS transaction_time,
        DATE_FORMAT(transaction_time, #{mysqlDateFormat}) AS dateUnit,vault_id
        FROM vault_apy WHERE  transaction_time &gt;= #{start} AND transaction_time &lt;= #{end}  and vault_id =#{businessPoolId}
        GROUP BY dateUnit) groupLastTime
        inner join vault_apy va on va.vault_id=groupLastTime.vault_id and va.transaction_time=groupLastTime.transaction_time
    </select>

    <select id="vaultAPYStatisticsMinTime" resultType="date">
        SELECT min(transaction_time) minTime from vault_apy where transaction_time &gt;= #{start} AND transaction_time &lt;= #{end}  and vault_id =#{businessPoolId}
    </select>

    <select id="vaultSharePriceLTTransactionTime" resultType="com.sui.haedal.model.vo.TimePeriodStatisticsVo">
        SELECT groupLastTime.*,CAST(ver.exchange_rate as CHAR) AS val from (
        SELECT 	max(transaction_time) AS transaction_time,
        DATE_FORMAT(transaction_time, '%Y-%m-%d') AS dateUnit,vault_id  FROM vault_exchange_rate
        WHERE transaction_time &lt;= #{end}  and vault_id =#{businessPoolId}
        GROUP BY dateUnit) groupLastTime
        inner join vault_exchange_rate ver on ver.vault_id=groupLastTime.vault_id and ver.transaction_time=groupLastTime.transaction_time
    </select>

    <select id="vaultYieldEarnedLTTransactionTime"  resultType="com.sui.haedal.model.vo.TimePeriodStatisticsVo">
        SELECT groupLastTime.*,CAST(vyer.earned_asset as CHAR) AS val from (
        SELECT 	max(transaction_time) AS transaction_time,
        DATE_FORMAT(transaction_time, '%Y-%m-%d') AS dateUnit,vault_id  FROM vault_yield_earned_record
        WHERE transaction_time &lt;= #{end}  and vault_id =#{businessPoolId}
        GROUP BY dateUnit) groupLastTime
        inner join vault_yield_earned_record vyer on vyer.vault_id=groupLastTime.vault_id and vyer.transaction_time=groupLastTime.transaction_time
    </select>

</mapper>